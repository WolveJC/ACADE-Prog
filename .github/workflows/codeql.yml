name: "CodeQL Advanced"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '16 4 * * 1'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest

    permissions:
      # Requerido para publicar los resultados
      security-events: write
      # Requerido para descargar paquetes de CodeQL
      packages: read
      contents: read 

    #  Eliminamos la matriz de lenguajes para evitar fallos por "No Code Found"
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1. SETUP DE ENTORNO
    # Estos pasos son necesarios para que los comandos 'mvn' y 'dotnet' funcionen si hay c贸digo C# o Java.
    - name: Setup Java Environment
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup .NET Environment
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # --- 2. INICIALIZACIN DE CODEQL (nica llamada para todos los lenguajes) ---
    # CodeQL ahora detectar谩 autom谩ticamente qu茅 lenguajes tienen c贸digo fuente 
    # y solo crear谩 bases de datos para ellos.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: c-cpp, java-kotlin, csharp, javascript-typescript, python, actions

    # 3. COMPILACIN CONDICIONAL Y SEGURA (Solo para lenguajes compilados)
    
    # --- C/C++ (MANUAL: Makefile) ---
    - name: Build C/C++
      # Ejecutar make codeql_all solo si existe el archivo Makefile, 
      # o si CodeQL detect贸 alg煤n archivo C/C++.
      shell: bash
      run: |
        if [ -f "Makefile" ]; then
          echo "Iniciando compilaci贸n C/C++ con Makefile..."
          make codeql_all
        else
          echo "No se encontr贸 Makefile. Saltando compilaci贸n C/C++."
        fi

    # --- JAVA/KOTLIN (MANUAL: Script Personalizado) ---
    - name: Build Java/Kotlin
      shell: bash
      # El script se ejecuta. Si no encuentra 'pom.xml', devuelve 茅xito (0), evitando el fallo.
      run: |
        echo "Iniciando compilaci贸n Java/Kotlin..."
        bash ./build_java.sh

    # --- C# (MANUAL: Script Personalizado) ---
    - name: Build C#
      shell: bash
      # El script se ejecuta. Si no encuentra '.sln' o '.csproj', devuelve 茅xito (0).
      run: |
        echo "Iniciando compilaci贸n C#..."
        bash ./build_csharp.sh
        
    # 4. ANLISIS FINAL
    # Este paso analizar谩 todas las bases de datos que CodeQL logr贸 crear.
    # Dado que no estamos en modo matriz, este paso no fallar谩 si una base de datos (ej. Java) no existe.
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
